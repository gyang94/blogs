import{_ as s,c as e,o as t,ae as i}from"./chunks/framework.Bk39dawk.js";const n="/blogs/assets/iceberg-file-structure.SSPznGtM.png",l="/blogs/assets/file-create-table.BfGQ0-ES.png",o="/blogs/assets/insert-second-row.BtxQ2tkE.png",p="/blogs/assets/insert-third-row.DjK3wdjt.png",r="/blogs/assets/data-file.D57NsKKT.png",c="/blogs/assets/query-snapshot.CdCssnsL.png",v=JSON.parse('{"title":"Iceberg","description":"","frontmatter":{"title":"Iceberg","tags":"Iceberg","outline":"deep"},"headers":[],"relativePath":"notes/iceberg/01-files.md","filePath":"notes/iceberg/01-files.md","lastUpdated":1745422262000}'),d={name:"notes/iceberg/01-files.md"};function h(g,a,m,b,u,_){return t(),e("div",null,a[0]||(a[0]=[i('<h1 id="iceberg文件布局" tabindex="-1">Iceberg文件布局 <a class="header-anchor" href="#iceberg文件布局" aria-label="Permalink to &quot;Iceberg文件布局&quot;">​</a></h1><h2 id="snapshots" tabindex="-1">Snapshots <a class="header-anchor" href="#snapshots" aria-label="Permalink to &quot;Snapshots&quot;">​</a></h2><p>paimon、hudi、iceberg等数据湖组件中都有snapshot(快照)、version(版本)的概念。不管是快照还是版本表示的是某一时刻对应表数据的一个完整的数据以及状态（元数据对应的完整数据）。同时快照、版本也是数据湖能够支持湖仓一体、流批一体的核心设计。</p><h2 id="文件布局" tabindex="-1">文件布局 <a class="header-anchor" href="#文件布局" aria-label="Permalink to &quot;文件布局&quot;">​</a></h2><h3 id="整体预览" tabindex="-1">整体预览 <a class="header-anchor" href="#整体预览" aria-label="Permalink to &quot;整体预览&quot;">​</a></h3><p>文件及布局如图所示 <img src="'+n+`" alt="iceberg-files.png"></p><h3 id="详细案例剖析" tabindex="-1">详细案例剖析 <a class="header-anchor" href="#详细案例剖析" aria-label="Permalink to &quot;详细案例剖析&quot;">​</a></h3><ol><li>创建iceberg表</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE TABLE ice_spark_hdfs.mj.t_user1 (</span></span>
<span class="line"><span>    id bigint,</span></span>
<span class="line"><span>    name string,</span></span>
<span class="line"><span>    dt string</span></span>
<span class="line"><span>)</span></span>
<span class="line"><span>USING iceberg</span></span></code></pre></div><p>其文件结构如图所示，只有metadata文件夹，内涵v1.metadata.json. <img src="`+l+'" alt="file-create-table"></p><ol start="2"><li>插入第一条数据</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>INSERT INTO ice_spark_hdfs.mj.t_user1 VALUES(1, &#39;flink&#39;, &#39;20250209&#39;);</span></span></code></pre></div><p>此时的表文件结构里会多出:</p><ul><li>版本的metadata文件 <code>metadata/v2.metadata.json</code></li><li>manifest-list文件 <code>metadata/snapshot-xxx.avro</code></li><li>manifest文件 <code>metadata/xxx.avro</code></li><li>data数据文件 <code>data/xxx.parquet</code>,</li></ul><p>这个snapshot只包含一条数据 (1, &#39;flink&#39;, &#39;20250209&#39;)</p><ol start="3"><li>插入第二条数据</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>INSERT INTO ice_spark_hdfs.mj.t_user1 VALUES(1, &#39;icebert&#39;, &#39;20250208&#39;);</span></span></code></pre></div><p>表文件结构里又会多出一组新的snapshot文件 (metadata.json, manifest-list, manifest, data)。</p><p>这个snapshot包含两条数据 (1, &#39;flink&#39;, &#39;20250209&#39;)，(1, &#39;icebert&#39;, &#39;20250208&#39;)。 <img src="'+o+'" alt="insert-second-row"></p><ol start="4"><li>插入第三条数据</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>INSERT INTO ice_spark_hdfs.mj.t_user1 VALUES(1, &#39;paimon&#39;, &#39;20250208&#39;);</span></span></code></pre></div><p>同理，表文件结构里又会多出一组snapshot文件。这个snaphot就包含三条数据。 <img src="'+p+'" alt="insert-third-row"></p><p>最终的文件结构和内容如图所示 <img src="'+r+`" alt=""></p><ul><li>在metadata.json文件里，指向了一个或多个manifest-list文件。比如v2.metadata.json里指向了第一个manifest-list文件，v3.metadata.json文件里指向了第一个和第二个manifest-list文件.</li><li>一个manifest-list文件里指向了一个或多个manifest file文件。</li><li>一个manifest file文件对应一个data的parquet文件。</li></ul><h3 id="查看snapshot数据" tabindex="-1">查看snapshot数据 <a class="header-anchor" href="#查看snapshot数据" aria-label="Permalink to &quot;查看snapshot数据&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SELECT * FROM ice_spark_hdfs.mj.t_user VERSION AS OF 807038129550906544;</span></span>
<span class="line"><span>SELECT * FROM ice_spark_hdfs.mj.t_user VERSION AS OF 3637382120488406324;</span></span>
<span class="line"><span>SELECT * FROM ice_spark_hdfs.mj.t_user VERSION AS OF 6713817133986968147;</span></span></code></pre></div><p><img src="`+c+'" alt=""></p><h3 id="查看avro格式的数据" tabindex="-1">查看avro格式的数据 <a class="header-anchor" href="#查看avro格式的数据" aria-label="Permalink to &quot;查看avro格式的数据&quot;">​</a></h3><p>通过avro-tools-1.10.1.jar可以将avro转成json格式.<a href="https://archive.apache.org/dist/avro/avro-1.10.1/java/" target="_blank" rel="noreferrer">下载地址</a></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>java -jar avro-tools-1.10.1.jar tojson --pretty /opt/test/layout1/manifest/manifest-list-c935e5b9-5701-4aa9-951a-61ceef8ffd23-0</span></span></code></pre></div>',30)]))}const k=s(d,[["render",h]]);export{v as __pageData,k as default};
